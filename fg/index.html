<!DOCTYPE html>
<html lang="sk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Primary Meta Tags -->
    <title>Platba LeQR.SK – Rýchle a jednoduché platby QR kódom</title>
    <meta name="title" content="Platba LeQR.SK – Rýchle a jednoduché platby QR kódom">
    <meta name="description"
        content="Vytvárajte QR kódy pre platby jednoducho, bez inštalácie. Moderná PWA pre platby vo formáte PayBySquare.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://platba.leqr.sk/">
    <meta property="og:title" content="Platba LeQR.SK – Rýchle platby cez QR kód">
    <meta property="og:description"
        content="Zadajte sumu, poznámku a získajte QR kód pre rýchlu platbu. Bez registrácie, bez stresu.">
    <meta property="og:image" content="https://platba.leqr.sk/images/og-image.png">
    <meta property="fb:app_id" content="3201019116712940" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://platba.leqr.sk/">
    <meta name="twitter:title" content="Platba LeQR.SK – Rýchle platby cez QR kód">
    <meta name="twitter:description"
        content="Vytvorte si bankový QR kód okamžite – pohodlne a bezpečne. Funguje aj offline.">
    <meta name="twitter:image" content="https://platba.leqr.sk/images/og-image.png">

    <!-- PWA and mobile -->
    <meta name="theme-color" content="#4c00c2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Platba LeQR.SK">

    <!-- PWA podpora -->
    <link rel="manifest" href="manifest.json?v=1.1.4">
    
    <!-- QR kód s logom - štýly -->
    <style>
        /* Modal okno štýly */
        #error-modal {
            transition: opacity 0.3s ease-in-out;
            backdrop-filter: blur(5px);
        }
        
        #error-modal.hidden {
            display: none;
            opacity: 0;
        }
        
        #error-modal:not(.hidden) {
            display: flex;
            opacity: 1;
        }
        
        /* Štýl pre kontajner QR kódu */
        .qr-with-logo {
            position: relative;
            overflow: visible;
            padding: 18px 18px 60px 18px !important; /* top right bottom left */
            border: 3px solid rgba(176, 216, 255, 0.9); /* Svetlomodrý rám s priehľadnosťou */
            border-radius: 10px;
            background-color: white;
        }
        
        /* PAY by square logo pod QR kódom */
        .qr-with-logo::after {
            content: "";
            position: absolute;
            bottom: 10px !important; /* Posunutie pod QR kód */
            left: 0;
            width: 100%;
            height: 60px !important;
            background-image: url('images/pay-bottom-dark.png?v=1.1.4');
            background-size: 315px auto; /* Väčšia šírka pre logo */
            background-position: center bottom;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 999;
        }
        
        /* QR kód sa zobrazí nad logom */
        #qr-code > * {
            position: relative;
            z-index: 1;
            margin: auto; /* Vycentrovanie QR kódu */
        }
    </style>
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- QR Code Generator knižnica -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <!-- Import bysquare as ES Module -->
    <script type="module">
        // Import bysquare knižnice
        import { encode, decode, PaymentOptions, CurrencyCode } from "https://esm.sh/bysquare@3.2.0";

        // Sprístupníme knižnicu globálne, aby ju mohli ostatné skripty používať
        window.bysquareModule = {
            encode,
            decode,
            PaymentOptions,
            CurrencyCode
        };

        // Signalizácia, že modul je načítaný
        window.bysquareLoaded = true;

        // Log pre overenie načítania
        console.log('Bysquare module loaded successfully');
    </script>
    <!-- Tailwind CSS -->
    <script src="tailwindcss.3.4.16.js"></script>
    <!-- FontAwesome Icons pre lepšiu používateľskú skúsenosť -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Registrácia Service Worker-a pre offline funkcionalitu -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                // Nová registrácia s cache-busting parametrom
                navigator.serviceWorker.register('sw.js?v=1.1.4').then(function (registration) {
                    // Registrácia bola úspešná
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    
                    // Kontrola dostupnosti aktualizácie
                    registration.update().then(() => console.log('Service worker aktualizácia skontrolovaná'));
                    
                    // Sledovanie aktualizácie service workera
                    let refreshing = false;
                    navigator.serviceWorker.addEventListener('controllerchange', function() {
                        if (refreshing) return;
                        const updatingTo = sessionStorage.getItem('sw_updating_to');
                        if (updatingTo) {
                            const alreadyReloaded = sessionStorage.getItem('sw_reloaded_to');
                            if (alreadyReloaded === updatingTo) {
                                console.log('[SW] controllerchange ignored (already reloaded to):', updatingTo);
                                return;
                            }
                            sessionStorage.setItem('sw_reloaded_to', updatingTo);
                        }
                        refreshing = true;
                        console.log('[SW] controllerchange -> reloading page', { updatingTo });
                        dataLayer.push({ 'event': 'service_worker_controller_changed' });
                        reloadWithCacheBusting();
                    });
                    
                    // Sledovanie úspešnej registrácie service workera
                    dataLayer.push({
                        'event': 'service_worker_registered',
                        'sw_scope': registration.scope
                    });
                }, function (err) {
                    // registrácia zlyhala :(
                    console.log('ServiceWorker registration failed: ', err);
                    // Sledovanie neúspešnej registrácie service workera
                    dataLayer.push({
                        'event': 'service_worker_registration_failed',
                        'error': err.toString()
                    });
                });

                // Track app open event
                const isReturningUser = localStorage.getItem('paybySquareSettings') !== null;
                dataLayer.push({
                    'event': 'app_opened',
                    'user_type': isReturningUser ? 'returning' : 'new'
                });

                // Track if app is in offline mode
                if (!navigator.onLine) {
                    dataLayer.push({
                        'event': 'offline_mode_entered'
                    });
                }

                // Listen for online/offline events
                window.addEventListener('online', function () {
                    dataLayer.push({
                        'event': 'app_online'
                    });
                });

                window.addEventListener('offline', function () {
                    dataLayer.push({
                        'event': 'offline_mode_entered'
                    });
                });

                // Track if app was launched from installed PWA
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    dataLayer.push({
                        'event': 'app_installed'
                    });
                }

                // Track app load time
                const loadTime = performance.now();
                dataLayer.push({
                    'event': 'app_load_time',
                    'load_time_ms': Math.round(loadTime)
                });
            });
        }
    </script>

    <script>
        // Tailwind konfigurácia pre konzistentné farby a mobile-first prístup
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f7ff',
                            100: '#e0eeff',
                            200: '#c7dfff',
                            300: '#a0c7fe',
                            400: '#72a9fc',
                            500: '#4f83f7',
                            600: '#3a63ee',
                            700: '#2e4fda',
                            800: '#2941b0',
                            900: '#263c8b',
                        },
                        secondary: {
                            50: '#f9f5ff',
                            100: '#f0e9ff',
                            200: '#e4d4ff',
                            300: '#cfb1fe',
                            400: '#b882fb',
                            500: '#a55af5',
                            600: '#933aea',
                            700: '#7e2ed1',
                            800: '#6827aa',
                            900: '#5b2589',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        glass: '0 8px 32px 0 rgba(31, 38, 135, 0.1)',
                        'glass-hover': '0 8px 32px 0 rgba(31, 38, 135, 0.2)',
                    }
                }
            }
        };
    </script>
    <script>
        // Zabezpečenie, že qrcode bude dostupný ako globálna funkcia
        window.addEventListener('load', function () {
            // Kontrola dostupnosti funkcie qrcode (s malým q) z knižnice qrcode-generator
            if (typeof qrcode === 'undefined' || typeof qrcode !== 'function') {
                console.error('qrcode-generator knižnica nebola načítaná správne. Generovanie QR kódu nemusí fungovať.');
            } else {
                console.log('qrcode-generator knižnica je dostupná:', typeof qrcode);
                try {
                    // Skúsme vytvoriť jednoduchý QR kód pre kontrolu funkčnosti
                    const testQr = qrcode(4, 'L');
                    console.log('qrcode-generator knižnica funguje správne');
                } catch (e) {
                    console.error('qrcode-generator knižnica je dostupná, ale nefunguje správne:', e);
                }
            }
        });
    </script>
    <style>
        /* Custom štýly, ktoré nie je možné dosiahnuť pomocou Tailwind */
        .animated-gradient {
            background: linear-gradient(-45deg, #4f83f7, #2e4fda, #a55af5, #7e2ed1);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-56CKR4RC');</script> 

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6CLTP3Q8GS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-6CLTP3Q8GS');
    </script>
    <!-- End Google Tag Manager -->
</head>

<body class="min-h-screen animated-gradient text-gray-800 p-4 antialiased">
    <!-- Notifikácia o aktualizácii -->
    <div id="update-notification"
        class="hidden fixed top-0 left-0 right-0 bg-secondary-600 text-white text-center p-2 z-50"></div>
        
    <!-- Modal okno pre chyby -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-md w-full p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-red-600"><i class="fas fa-exclamation-circle mr-2"></i> <span id="error-modal-title">Upozornenie</span></h3>
                <button onclick="closeModal('error-modal')" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-5">
                <p id="error-modal-message" class="text-gray-700"></p>
            </div>
            <div class="text-right">
                <button onclick="closeModal('error-modal')"
                    class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 focus:outline-none">
                    Rozumiem
                </button>
            </div>
        </div>
    </div>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-56CKR4RC" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="max-w-6xl mx-auto">
        <!-- Hlavička -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-2 drop-shadow-lg">
                <i class="fas fa-qrcode mr-2"></i> Platba LeQR.SK
            </h1>
            <p class="text-white text-opacity-90 text-lg md:text-xl">Mobilné platby jednoducho <span
                    id="app-version-display" class="text-sm opacity-70"></span></p>
        </header>

        <!-- Hlavný obsah - okno 1 a okno 2, vždy len jedno viditeľné -->
        <div class="max-w-xl mx-auto">
            <!-- Okno 1: Panel s formulárom -->
            <div id="payment-panel"
                class="glassmorphism rounded-2xl shadow-glass hover:shadow-glass-hover transition duration-300">
                <!-- Záložky -->
                <div class="flex rounded-t-2xl overflow-hidden">
                    <button id="payment-tab" onclick="switchTab('payment')"
                        class="flex-1 py-3 px-4 font-medium transition duration-300 bg-white text-primary-600">
                        <i class="fas fa-credit-card mr-2"></i> Platba
                    </button>
                    <button id="settings-tab" onclick="switchTab('settings')"
                        class="flex-1 py-3 px-4 font-medium transition duration-300 bg-gray-100 bg-opacity-50 text-gray-600">
                        <i class="fas fa-cog mr-2"></i> Nastavenia
                    </button>
                </div>

                <!-- Formulár platby -->
                <div id="payment-form" class="p-5">
                    <h2 class="text-xl font-bold text-primary-700 mb-4 pb-2 border-b border-gray-200">Vytvorenie platobného QR
                    </h2>

                    <!-- Suma -->
                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Suma (€)</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-euro-sign text-gray-400"></i>
                            </div>
                            <input type="text" inputmode="decimal" pattern="[0-9]+(\.[0-9]{0,2})?" id="amount"
                                min="0.01" placeholder="5.00"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200"
                                onkeypress="return isNumberKey(event)" onpaste="return validatePaste(event)">
                        </div>
                        <div id="amount-error" class="mt-1 text-sm text-red-600"></div>

                        <label class="mt-3 flex items-start gap-3 select-none cursor-pointer">
                            <input id="no-amount" type="checkbox"
                                class="mt-1 h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                            <span class="text-sm text-gray-700">
                                <span class="font-medium">Bez sumy</span>
                                <span class="block text-xs text-gray-500">Suma nebude súčasťou QR kódu</span>
                            </span>
                        </label>
                    </div>

                    <!-- Poznámka -->
                    <div class="mb-4">
                        <label for="note" class="block text-sm font-medium text-gray-700 mb-2">Poznámka k platbe <span id="note-required" class="hidden text-red-600">*</span></label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-comment-alt text-gray-400"></i>
                            </div>
                            <input type="text" id="note" maxlength="35" placeholder="Popis platby (max 35 znakov)"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                        <div id="note-error" class="mt-1 text-sm text-red-600"></div>
                    </div>

                    <!-- Variabilný symbol -->
                    <div class="mb-6">
                        <label for="vs-display" class="block text-sm font-medium text-gray-700 mb-2">Variabilný
                            symbol</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-hashtag text-gray-400"></i>
                            </div>
                            <input type="text" id="vs-display" readonly placeholder="Automaticky generovaný"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 bg-gray-50 rounded-lg cursor-not-allowed transition duration-200">
                        </div>

                        <label class="mt-3 flex items-start gap-3 select-none cursor-pointer">
                            <input id="no-vs" type="checkbox"
                                class="mt-1 h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                            <span class="text-sm text-gray-700">
                                <span class="font-medium">Bez VS</span>
                                <span class="block text-xs text-gray-500">Variabilný symbol nebude súčasťou QR kódu</span>
                            </span>
                        </label>
                    </div>

                    <!-- Tlačidlo generovať QR -->
                    <button onclick="generateQR()"
                        class="w-full py-3 bg-gradient-to-r from-primary-600 to-secondary-600 hover:from-primary-700 hover:to-secondary-700 rounded-lg text-white font-medium flex items-center justify-center transform transition duration-300 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-qrcode mr-2"></i> Generovať QR kód
                    </button>
                </div>

                <!-- Formulár nastavení -->
                <div id="settings-form" class="p-5 hidden">
                    <h2 class="text-xl font-bold text-primary-700 mb-4 pb-2 border-b border-gray-200">Bankové údaje</h2>

                    <!-- IBAN -->
                    <div class="mb-4">
                        <label for="iban" class="block text-sm font-medium text-gray-700 mb-2">IBAN účtu</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-university text-gray-400"></i>
                            </div>
                            <input type="text" id="iban" placeholder="SK7700000000000000000000" maxlength="34"
                                class="uppercase block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                        <div id="iban-error" class="mt-1 text-sm text-red-600"></div>
                    </div>

                    <!-- SWIFT/BIC -->
                    <div class="mb-4">
                        <label for="swift" class="block text-sm font-medium text-gray-700 mb-2">SWIFT/BIC kód</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-globe text-gray-400"></i>
                            </div>
                            <input type="text" id="swift" placeholder="CEKOSKBX" maxlength="11"
                                class="uppercase block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                    </div>

                    <!-- Meno majiteľa účtu -->
                    <div class="mb-6">
                        <label for="recipient" class="block text-sm font-medium text-gray-700 mb-2">Meno/Názov majiteľa
                            účtu</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-building text-gray-400"></i>
                            </div>
                            <input type="text" id="recipient" placeholder="Meno alebo názov majiteľa účtu"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                        <div id="recipient-error" class="mt-1 text-sm text-red-600"></div>
                    </div>

                    <!-- Tlačidlo uložiť -->
                    <button onclick="saveSettings()"
                        class="w-full py-3 bg-gradient-to-r from-primary-600 to-secondary-600 hover:from-primary-700 hover:to-secondary-700 rounded-lg text-white font-medium flex items-center justify-center transform transition duration-300 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-save mr-2"></i> Uložiť nastavenia
                    </button>

                    <!-- Potvrdenie uloženia -->
                    <div id="settings-success"
                        class="mt-4 py-2 px-3 bg-green-100 border border-green-300 text-green-700 text-center rounded-md hidden transition duration-300">
                        <i class="fas fa-check-circle mr-1"></i> Nastavenia boli úspešne uložené
                    </div>
                </div>
            </div>

            <!-- Okno 2: Panel s QR kódom (skryté na začiatku) -->
            <div id="qr-panel" class="glassmorphism rounded-2xl shadow-glass hidden">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary-700">Váš QR kód na platbu</h2>
                        <button onclick="backToPaymentForm()"
                            class="py-1 px-3 text-sm text-gray-600 hover:text-primary-700 hover:bg-gray-100 rounded-md transition">
                            <i class="fas fa-arrow-left mr-1"></i> Späť
                        </button>
                    </div>
                    <div id="qr-placeholder" class="text-center p-10">
                        <i class="fas fa-spinner fa-pulse text-4xl text-gray-400"></i>
                        <p class="mt-3 text-gray-500">Generujem QR kód...</p>
                    </div>
                    <div id="qr-code" class="bg-white p-5 rounded-xl shadow-md my-4 hidden flex justify-center relative qr-with-logo"></div>
                    <div id="qr-actions" class="hidden mt-3 flex flex-col sm:flex-row gap-3">
                        <button id="copy-qr-btn" onclick="copyQrToClipboard()"
                            class="flex-1 py-3 bg-white hover:bg-gray-50 rounded-lg text-gray-800 font-medium border border-gray-200 flex items-center justify-center transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <i class="fas fa-copy mr-2"></i> Kopírovať QR
                        </button>
                        <button id="save-qr-btn" onclick="saveQrImage()"
                            class="flex-1 py-3 bg-gradient-to-r from-primary-600 to-secondary-600 hover:from-primary-700 hover:to-secondary-700 rounded-lg text-white font-medium flex items-center justify-center transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <i class="fas fa-download mr-2"></i> Uložiť
                        </button>
                    </div>
                    <div id="qr-info"
                        class="w-full mt-3 bg-gray-50 p-4 rounded-lg border-l-4 border-primary-500 text-sm hidden">
                        <div class="grid grid-cols-1 gap-2">
                            <p><strong>Suma:</strong> <span id="qr-amount"></span></p>
                            <p><strong>IBAN:</strong> <span id="qr-iban"></span></p>
                            <p><strong>VS:</strong> <span id="qr-vs"></span></p>
                            <p><strong>Poznámka:</strong> <span id="qr-note"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-6 text-center text-white text-opacity-80 text-xs">
            <div class="inline-block px-4 py-2 rounded-lg bg-white bg-opacity-10">
                <span>Autor: Slavoj SANTA Hruška</span>
                <span class="mx-2">|</span>
                <span>Copyright © 2025</span>
                <span class="mx-2">|</span>
                <span>
                    Kontakt:
                    <a id="contact-email" href="#" class="underline hover:text-white">email</a>
                </span>
            </div>
        </footer>
    </div>

    <script>
        // Úložisko v pamäti (v reálnej implementácii nahradené lokálnym úložiskom)
        let settings = {
            iban: '',
            swift: '',
            recipient: '',
            noAmount: false,
            noVS: false
        };

        let lastPayBySquareString = null;

        let dailyCounters = {};

        // Load settings on page load
        window.onload = function () {
            loadSettings();
            updateVSDisplay();
            attachPaymentOptionHandlers();
            syncPaymentFormState();
        };

        document.addEventListener('DOMContentLoaded', function () {
            const el = document.getElementById('contact-email');
            if (!el) return;

            const user = ['in', 'fo'].join('');
            const domain = ['san', 'ta', '3d'].join('');
            const tld = ['s', 'k'].join('');
            const email = `${user}@${domain}.${tld}`;

            const subject = encodeURIComponent('Kontakt ohľadne projektu Platba LeQR.SK');
            el.textContent = email;
            el.href = `mailto:${email}?subject=${subject}`;
        });

        function switchTab(tab) {
            // Skryjeme všetky formuláre
            document.getElementById('payment-form').classList.add('hidden');
            document.getElementById('settings-form').classList.add('hidden');

            // Zobrazíme len vybraný formulár
            document.getElementById(tab + '-form').classList.remove('hidden');

            // Aktualizujeme štýly tlačidiel záložiek
            if (tab === 'payment') {
                document.getElementById('payment-tab').classList.remove('bg-gray-100', 'bg-opacity-50', 'text-gray-600');
                document.getElementById('payment-tab').classList.add('bg-white', 'text-primary-600');

                document.getElementById('settings-tab').classList.remove('bg-white', 'text-primary-600');
                document.getElementById('settings-tab').classList.add('bg-gray-100', 'bg-opacity-50', 'text-gray-600');

                // Track payment tab opened
                dataLayer.push({
                    'event': 'payment_form_opened'
                });
            } else {
                document.getElementById('settings-tab').classList.remove('bg-gray-100', 'bg-opacity-50', 'text-gray-600');
                document.getElementById('settings-tab').classList.add('bg-white', 'text-primary-600');

                document.getElementById('payment-tab').classList.remove('bg-white', 'text-primary-600');
                document.getElementById('payment-tab').classList.add('bg-gray-100', 'bg-opacity-50', 'text-gray-600');

                // Track settings tab opened
                dataLayer.push({
                    'event': 'settings_opened'
                });
            }
        }

        // Load settings from localStorage on page load
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('paybySquareSettings');
                const savedCounters = localStorage.getItem('paybySquareDailyCounters');

                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                    settings.noAmount = !!settings.noAmount;
                    settings.noVS = !!settings.noVS;
                    console.log('Nastavenia načítané z localStorage:', settings);

                    // Vyplníme formulár načítanými hodnotami
                    if (settings.iban) document.getElementById('iban').value = settings.iban;
                    if (settings.swift) document.getElementById('swift').value = settings.swift;
                    if (settings.recipient) document.getElementById('recipient').value = settings.recipient;
                }

                const noAmountEl = document.getElementById('no-amount');
                const noVsEl = document.getElementById('no-vs');
                if (noAmountEl) noAmountEl.checked = !!settings.noAmount;
                if (noVsEl) noVsEl.checked = !!settings.noVS;

                if (savedCounters) {
                    dailyCounters = JSON.parse(savedCounters);
                    console.log('Počítadlá načítané z localStorage:', dailyCounters);
                }

                updateVSDisplay();
                syncPaymentFormState();
            } catch (error) {
                console.error('Chyba pri načítavaní dát z localStorage:', error);
            }
        }

        function saveSettings() {
            const inputIban = document.getElementById('iban').value.trim();
            const swift = document.getElementById('swift').value.trim();
            const recipient = document.getElementById('recipient').value.trim();
            const recipientErrorEl = document.getElementById('recipient-error');

            // Track form interaction
            dataLayer.push({
                'event': 'settings_form_submitted',
                'has_swift': swift.trim() !== '',
                'has_recipient': recipient.trim() !== ''
            });

            // Validate IBAN and get the cleaned version (without spaces)
            const validatedIban = validateIBAN(inputIban);
            if (!validatedIban) {
                document.getElementById('iban-error').textContent = 'Zadajte platný IBAN';

                // Track IBAN validation error
                dataLayer.push({
                    'event': 'iban_validation_error',
                    'input_length': inputIban.length
                });
                return;
            }

            document.getElementById('iban-error').textContent = '';

            if (!recipient) {
                if (recipientErrorEl) recipientErrorEl.textContent = 'Zadajte meno/názov majiteľa účtu';

                dataLayer.push({
                    'event': 'recipient_validation_error'
                });
                return;
            }
            if (recipientErrorEl) recipientErrorEl.textContent = '';

            settings = {
                iban: validatedIban,
                swift,
                recipient,
                noAmount: !!settings.noAmount,
                noVS: !!settings.noVS
            };

            // Uložíme nastavenia do localStorage
            try {
                localStorage.setItem('paybySquareSettings', JSON.stringify(settings));
                console.log('Nastavenia uložené do localStorage:', settings);

                // Track successful settings save
                dataLayer.push({
                    'event': 'settings_saved',
                    'country_code': validatedIban.slice(0, 2),
                    'has_swift': swift.trim() !== '',
                    'has_recipient': recipient.trim() !== ''
                });
            } catch (error) {
                console.error('Chyba pri ukladaní nastavení do localStorage:', error);

                // Track localStorage error
                dataLayer.push({
                    'event': 'settings_save_error',
                    'error_type': 'localStorage_error'
                });
            }

            const successEl = document.getElementById('settings-success');
            successEl.textContent = 'Nastavenia uložené!';
            successEl.classList.remove('hidden');

            // Uložíme a prejdeme na záložku platby po 1.5s
            setTimeout(() => {
                switchTab('payment');
                successEl.classList.add('hidden');
                successEl.textContent = '';
            }, 1500);
        }

        function persistSettings() {
            try {
                localStorage.setItem('paybySquareSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('Chyba pri ukladaní nastavení do localStorage:', error);
            }
        }

        function attachPaymentOptionHandlers() {
            const noAmountEl = document.getElementById('no-amount');
            const noVsEl = document.getElementById('no-vs');
            if (noAmountEl) {
                noAmountEl.addEventListener('change', () => {
                    settings.noAmount = !!noAmountEl.checked;
                    persistSettings();
                    syncPaymentFormState();
                });
            }
            if (noVsEl) {
                noVsEl.addEventListener('change', () => {
                    settings.noVS = !!noVsEl.checked;
                    persistSettings();
                    syncPaymentFormState();
                    updateVSDisplay();
                });
            }
        }

        function syncPaymentFormState() {
            const amountEl = document.getElementById('amount');
            const noteRequiredEl = document.getElementById('note-required');
            const noteErrorEl = document.getElementById('note-error');
            const amountErrorEl = document.getElementById('amount-error');
            const vsEl = document.getElementById('vs-display');

            const noteRequired = !!settings.noAmount || !!settings.noVS;
            if (noteRequiredEl) noteRequiredEl.classList.toggle('hidden', !noteRequired);
            if (!noteRequired && noteErrorEl) noteErrorEl.textContent = '';

            if (amountEl) {
                amountEl.disabled = !!settings.noAmount;
                amountEl.classList.toggle('bg-gray-50', !!settings.noAmount);
                amountEl.classList.toggle('cursor-not-allowed', !!settings.noAmount);
                if (settings.noAmount) {
                    amountEl.value = '';
                    if (amountErrorEl) amountErrorEl.textContent = '';
                }
            }

            if (vsEl) {
                if (settings.noVS) {
                    vsEl.value = '';
                }
            }
        }

        function validateIBAN(iban) {
            console.log('Validating IBAN:', iban);

            // Remove spaces from the IBAN
            const cleanIban = iban.replace(/\s/g, '').toUpperCase();
            console.log('Cleaned IBAN:', cleanIban);

            // IBAN country code length map
            const countryLengths = {
                AL: 28, AD: 24, AT: 20, AZ: 28, BH: 22, BY: 28, BE: 16, BA: 20, BR: 29,
                BG: 22, CR: 22, HR: 21, CY: 28, CZ: 24, DK: 18, DO: 28, EG: 29, SV: 28,
                EE: 20, FO: 18, FI: 18, FR: 27, GE: 22, DE: 22, GI: 23, GR: 27, GL: 18,
                GT: 28, VA: 22, HU: 28, IS: 26, IQ: 23, IE: 22, IL: 23, IT: 27, JO: 30,
                KZ: 20, XK: 20, KW: 30, LV: 21, LB: 28, LI: 21, LT: 20, LU: 20, MK: 19,
                MT: 31, MR: 27, MU: 30, MD: 24, MC: 27, ME: 22, NL: 18, NO: 15, PK: 24,
                PS: 29, PL: 28, PT: 25, QA: 29, RO: 24, LC: 32, SM: 27, ST: 25, SA: 24,
                RS: 22, SC: 31, SK: 24, SI: 19, ES: 24, SE: 24, CH: 21, TL: 23, TN: 24,
                TR: 26, UA: 29, AE: 23, GB: 22, VG: 24
            };

            // Check if it's a string with minimum IBAN length
            if (typeof cleanIban !== 'string') {
                console.error('IBAN validation failed: Not a string');
                return false;
            }

            if (cleanIban.length < 15) {
                console.error('IBAN validation failed: Length too short (minimum 15 characters)', cleanIban.length);
                return false;
            }

            // Extract country code
            const countryCode = cleanIban.slice(0, 2);
            console.log('Country code:', countryCode);

            // Verify country code is supported
            if (!Object.keys(countryLengths).includes(countryCode)) {
                console.error('IBAN validation failed: Unsupported country code', countryCode);
                return false;
            }

            // Verify length for country
            const expectedLength = countryLengths[countryCode];
            if (expectedLength !== cleanIban.length) {
                console.error('IBAN validation failed: Invalid length for country', {
                    country: countryCode,
                    expected: expectedLength,
                    actual: cleanIban.length
                });
                return false;
            }

            // Move first 4 characters to the end
            const reformattedIban = cleanIban.slice(4) + cleanIban.slice(0, 4);
            console.log('Reformatted IBAN:', reformattedIban);

            // Replace letters with corresponding numbers (A=10, B=11, etc.)
            const onlyDigits = reformattedIban.replace(/[A-Z]/g, letter =>
                (letter.charCodeAt(0) - 55).toString()
            );
            console.log('Digits only:', onlyDigits);

            // Perform the mod-97 operation
            function mod97(numStr) {
                let checksum = numStr.slice(0, 2);
                let fragment;

                for (let offset = 2; offset < numStr.length; offset += 7) {
                    fragment = checksum + numStr.substring(offset, offset + 7);
                    checksum = parseInt(fragment, 10) % 97;
                }

                return checksum;
            }

            // IBAN is valid if the remainder is 1
            const remainder = mod97(onlyDigits);
            const isValid = remainder === 1;

            if (!isValid) {
                console.error('IBAN validation failed: Invalid checksum', {
                    remainder: remainder,
                    expected: 1
                });
            } else {
                console.log('IBAN validation successful!');
            }

            // Return both validation result and cleaned IBAN
            return isValid ? cleanIban : false;
        }

        function generateVS() {
            const today = new Date();
            const dateKey = today.toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD

            const nextCounter = (dailyCounters[dateKey] || 0) + 1;
            return dateKey + String(nextCounter).padStart(6, '0');
        }

        function commitVS() {
            const today = new Date();
            const dateKey = today.toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD

            if (!dailyCounters[dateKey]) {
                dailyCounters[dateKey] = 0;
            }

            dailyCounters[dateKey]++;

            // Prune kľúčov starších ako 7 dní
            const keys = Object.keys(dailyCounters);
            if (keys.length > 7) {
                const cutoff = new Date(today.getTime() - 7 * 86400000);
                const cutoffKey = cutoff.toISOString().slice(2, 10).replace(/-/g, '');
                keys.forEach(k => { if (k < cutoffKey) delete dailyCounters[k]; });
            }

            // Uložíme počítadlá do localStorage
            try {
                localStorage.setItem('paybySquareDailyCounters', JSON.stringify(dailyCounters));
            } catch (error) {
                console.error('Chyba pri ukladaní počítadiel do localStorage:', error);
            }
        }

        function updateVSDisplay() {
            if (settings.noVS) {
                document.getElementById('vs-display').value = '';
                return;
            }
            const today = new Date();
            const dateKey = today.toISOString().slice(2, 10).replace(/-/g, '');
            const nextCounter = (dailyCounters[dateKey] || 0) + 1;
            const nextVS = dateKey + String(nextCounter).padStart(6, '0');

            document.getElementById('vs-display').value = nextVS;
        }

        // Funkcia na formátovanie IBAN pre lepšiu čitateľnosť
        function formatIBAN(iban) {
            // Vkladá medzery po každých 4 znakoch
            if (!iban) return '';
            return iban.replace(/(.{4})/g, '$1 ').trim();
        }

        let payBottomLogoPromise = null;
        let payBottomLogoObjectUrl = null;

        function getPayBottomLogoImage() {
            if (payBottomLogoPromise) return payBottomLogoPromise;
            payBottomLogoPromise = (async () => {
                try {
                    const response = await fetch('images/pay-bottom-dark.png', { cache: 'force-cache' });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const blob = await response.blob();
                    payBottomLogoObjectUrl = URL.createObjectURL(blob);

                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = payBottomLogoObjectUrl;
                    });

                    return img;
                } catch (e) {
                    console.warn('PAY by square logo could not be loaded for export:', e);
                    return null;
                }
            })();
            return payBottomLogoPromise;
        }

        async function renderQrToCanvas(data, sizePx = 1024) {
            const typeNumber = 10;
            const errorCorrectionLevel = 'L';

            const qr = qrcode(typeNumber, errorCorrectionLevel);
            qr.addData(data);
            qr.make();

            const moduleCount = qr.getModuleCount();

            // Match UI framing (see .qr-with-logo)
            const borderPx = 3;
            const paddingTopPx = 18;
            const paddingRightPx = 18;
            const paddingBottomPx = 60;
            const paddingLeftPx = 18;
            const cornerRadiusPx = 10;
            const frameColor = 'rgba(176, 216, 255, 0.9)';

            const contentWidth = sizePx - (2 * borderPx) - paddingLeftPx - paddingRightPx;
            const contentHeight = sizePx - (2 * borderPx) - paddingTopPx - paddingBottomPx;
            const qrSizePx = Math.floor(Math.min(contentWidth, contentHeight));

            const startX = borderPx + paddingLeftPx + Math.floor((contentWidth - qrSizePx) / 2);
            const startY = borderPx + paddingTopPx;

            const canvas = document.createElement('canvas');
            canvas.width = sizePx;
            canvas.height = sizePx;
            const ctx = canvas.getContext('2d');

            const roundedRectPath = (x, y, w, h, r) => {
                const rr = Math.min(r, w / 2, h / 2);
                ctx.beginPath();
                ctx.moveTo(x + rr, y);
                ctx.arcTo(x + w, y, x + w, y + h, rr);
                ctx.arcTo(x + w, y + h, x, y + h, rr);
                ctx.arcTo(x, y + h, x, y, rr);
                ctx.arcTo(x, y, x + w, y, rr);
                ctx.closePath();
            };

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // White background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, sizePx, sizePx);

            // Frame border
            ctx.strokeStyle = frameColor;
            ctx.lineWidth = borderPx;
            roundedRectPath(borderPx / 2, borderPx / 2, sizePx - borderPx, sizePx - borderPx, cornerRadiusPx);
            ctx.stroke();

            // Draw QR
            const cellSize = qrSizePx / moduleCount;
            ctx.fillStyle = '#000000';
            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col)) {
                        const w = Math.ceil((col + 1) * cellSize) - Math.floor(col * cellSize);
                        const h = Math.ceil((row + 1) * cellSize) - Math.floor(row * cellSize);
                        ctx.fillRect(
                            Math.round(startX + (col * cellSize)),
                            Math.round(startY + (row * cellSize)),
                            w,
                            h
                        );
                    }
                }
            }

            // Draw PAY by square image at bottom (matches CSS background-size: 315px auto, bottom offset 10px)
            const img = await getPayBottomLogoImage();
            if (img) {
                const desiredWidth = Math.min(315, sizePx - 40);
                const scale = desiredWidth / img.width;
                const drawW = desiredWidth;
                const drawH = Math.round(img.height * scale);
                const drawX = Math.round((sizePx - drawW) / 2);
                const drawY = Math.round(sizePx - borderPx - 10 - drawH);
                ctx.drawImage(img, drawX, drawY, drawW, drawH);
            }

            return canvas;
        }

        async function renderQrCardToCanvas(data, sizePx = 1024) {
            // Outer card styling (matches #qr-code container: bg-white p-5 rounded-xl shadow-md)
            const outerPaddingPx = 20;
            const cardRadiusPx = 12;
            const shadowMarginPx = 26;

            const canvas = document.createElement('canvas');
            canvas.width = sizePx;
            canvas.height = sizePx;
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const roundedRectPath = (x, y, w, h, r) => {
                const rr = Math.min(r, w / 2, h / 2);
                ctx.beginPath();
                ctx.moveTo(x + rr, y);
                ctx.arcTo(x + w, y, x + w, y + h, rr);
                ctx.arcTo(x + w, y + h, x, y + h, rr);
                ctx.arcTo(x, y + h, x, y, rr);
                ctx.arcTo(x, y, x + w, y, rr);
                ctx.closePath();
            };

            const cardX = shadowMarginPx;
            const cardY = shadowMarginPx;
            const cardW = sizePx - (2 * shadowMarginPx);
            const cardH = sizePx - (2 * shadowMarginPx);

            // Shadow behind the card
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.18)';
            ctx.shadowBlur = 18;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 8;
            ctx.fillStyle = '#FFFFFF';
            roundedRectPath(cardX, cardY, cardW, cardH, cardRadiusPx);
            ctx.fill();
            ctx.restore();

            // Card fill (clean edges without shadow)
            ctx.fillStyle = '#FFFFFF';
            roundedRectPath(cardX, cardY, cardW, cardH, cardRadiusPx);
            ctx.fill();

            // Inner framed QR (matches .qr-with-logo)
            const innerSize = Math.floor(Math.min(cardW, cardH) - (2 * outerPaddingPx));
            const innerCanvas = await renderQrToCanvas(data, innerSize);
            const innerX = Math.round(cardX + outerPaddingPx + ((cardW - (2 * outerPaddingPx) - innerSize) / 2));
            const innerY = Math.round(cardY + outerPaddingPx + ((cardH - (2 * outerPaddingPx) - innerSize) / 2));
            ctx.drawImage(innerCanvas, innerX, innerY, innerSize, innerSize);

            return canvas;
        }

        function getQrFilename() {
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            return `leqr-qr-${ts}.png`;
        }

        async function getQrPngBlob() {
            if (!lastPayBySquareString) {
                throw new Error('QR kód nie je pripravený.');
            }
            const canvas = await renderQrCardToCanvas(lastPayBySquareString, 1024);
            return new Promise((resolve, reject) => {
                canvas.toBlob((blob) => {
                    if (!blob) {
                        reject(new Error('Nepodarilo sa pripraviť obrázok QR kódu.'));
                        return;
                    }
                    resolve(blob);
                }, 'image/png');
            });
        }

        async function copyQrToClipboard() {
            try {
                const blob = await getQrPngBlob();
                if (!navigator.clipboard || !window.ClipboardItem) {
                    throw new Error('Kopírovanie do schránky nie je podporované v tomto prehliadači.');
                }
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': blob
                    })
                ]);
                showErrorModal('Skopírované', 'QR kód bol skopírovaný do schránky ako obrázok.');
            } catch (e) {
                console.error('Copy QR failed:', e);
                alert(e.message || 'Kopírovanie QR kódu zlyhalo.');
            }
        }

        async function saveQrImage() {
            try {
                const blob = await getQrPngBlob();
                const file = new File([blob], getQrFilename(), { type: 'image/png' });

                const url = URL.createObjectURL(blob);

                const ua = navigator.userAgent || '';
                const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;

                if (isIOS) {
                    // iOS Safari typicky ignoruje download atribút; otvoríme obrázok v novej karte,
                    // kde si ho používateľ vie uložiť do Fotiek.
                    window.open(url, '_blank');
                    setTimeout(() => URL.revokeObjectURL(url), 60_000);
                    return;
                }

                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('Save QR failed:', e);
                alert(e.message || 'Uloženie QR kódu zlyhalo.');
            }
        }

        function generatePayBySquareString(amount, vs, note, iban, swift, recipient) {
            try {
                // Počkáme, či je bysquare knižnica načítaná
                if (!window.bysquareLoaded || !window.bysquareModule) {
                    throw new Error('Knižnica bysquare nie je načítaná. Prosím, obnovte stránku.');
                }

                // Používame globálne dostupnú bysquare knižnicu
                const { encode, PaymentOptions, CurrencyCode } = window.bysquareModule;

                // Príprava platobných údajov podľa dokumentácie bysquare
                const paymentData = {
                    payments: [
                        {
                            type: PaymentOptions.PaymentOrder, // PaymentOrder = 1
                            ...(amount !== null && amount !== undefined && amount !== '' && { amount: parseFloat(amount) }),
                            currencyCode: CurrencyCode.EUR,
                            // Pridáme variabilný symbol, ak je zadaný
                            ...(vs && vs.trim() !== '' && { variableSymbol: vs.toString() }),
                            // Pridáme poznámku, ak je zadaná
                            ...(note && note.trim() !== '' && { paymentNote: note, originatorsReferenceInformation: note }),
                            // Pridáme bankové účty
                            bankAccounts: [
                                {
                                    iban: iban,
                                    // Pridáme SWIFT/BIC kód, ak je zadaný
                                    ...(swift && swift.trim() !== '' && { bic: swift })
                                }
                            ],
                            beneficiary: {
                                name: (recipient || '').toString().trim()
                            }
                        }
                    ]
                };

                // Vygenerovanie kódu PayBySquare
                console.log('Generujem PayBySquare kód s údajmi:', paymentData);
                const payBySquareString = encode(paymentData);
                console.log('PayBySquare kód vygenerovaný:', payBySquareString);
                return payBySquareString;
            } catch (error) {
                console.error('Chyba pri generovaní PayBySquare kódu:', error);
                alert('Nepodarilo sa vygenerovať PayBySquare kód: ' + error.message);
                return null;
            }
        }

        // Funkcia pre prepnutie späť do okna platby
        function backToPaymentForm() {
            // Skryjeme QR panel
            document.getElementById('qr-panel').classList.add('hidden');

            // Zobrazíme platbný panel
            document.getElementById('payment-panel').classList.remove('hidden');

            // Track return to payment form
            dataLayer.push({
                'event': 'return_to_payment_form'
            });

            // Vymažeme hodnoty vo formulári
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';

            // Focus na pole sumy pre rýchle vyplnenie
            document.getElementById('amount').focus();
        }

        // Funkcia na zobrazenie chybového modalu
        function showErrorModal(title, message) {
            document.getElementById('error-modal-title').textContent = title;
            document.getElementById('error-modal-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
            
            // Track error event
            dataLayer.push({
                'event': 'error_modal_shown',
                'error_title': title,
                'error_message': message
            });
        }
        
        // Funkcia na zatvorenie modalu
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function generateQR() {
            // Get form values
            const noAmount = !!settings.noAmount;
            const noVS = !!settings.noVS;

            if (!settings.iban || !settings.recipient || settings.recipient.trim() === '') {
                showErrorModal('Chýbajú bankové údaje', 'Prosím, doplňte IBAN a meno/názov majiteľa účtu v Nastaveniach.');
                switchTab('settings');
                return;
            }

            const amount = noAmount ? '' : document.getElementById('amount').value;
            const vs = noVS ? '' : generateVS();
            const noteInput = document.getElementById('note').value;
            const noteErrorEl = document.getElementById('note-error');
            const noteRequired = noAmount || noVS;
            if (noteRequired && noteInput.trim() === '') {
                if (noteErrorEl) noteErrorEl.textContent = 'Poznámka je povinná.';
                showErrorModal('Chýba poznámka', 'Pri voľbe „Bez sumy“ alebo „Bez VS“ je poznámka povinná.');
                return;
            }
            if (noteErrorEl) noteErrorEl.textContent = '';
            let note = noteInput.trim();
            
            // Validovat sumu - musí byť väčšia ako 0 a menšia ako 400 EUR
            if (!noAmount) {
                const amountValue = parseFloat(amount);
                if (isNaN(amountValue) || amountValue <= 0) {
                    showErrorModal('Neplatná suma', 'Suma platby musí byť väčšia ako 0 EUR.');
                    
                    // Track validation error
                    dataLayer.push({
                        'event': 'amount_validation_error',
                        'error_type': 'zero_or_negative'
                    });
                    return;
                }
                
                if (amountValue >= 400) {
                    showErrorModal('Prekročený limit sumy', 'Suma platby nesmie prekročiť 400 EUR kvôli možnému problému s odpočtom DPH pri e-kasa bločkoch.');
                    
                    // Track validation error
                    dataLayer.push({
                        'event': 'amount_validation_error',
                        'error_type': 'over_limit',
                        'amount': amountValue
                    });
                    return;
                }
            }

            // Track payment form interaction
            dataLayer.push({
                'event': 'payment_form_started',
                'has_note': note.trim() !== ''
            });

            // Check if bysquare module is loaded
            if (!window.bysquareLoaded) {
                console.log('Bysquare module not yet loaded, waiting...');

                // Track library loading wait
                dataLayer.push({
                    'event': 'bysquare_library_loading',
                    'action': 'waiting'
                });

                // Wait a moment for the module to load
                setTimeout(() => {
                    if (window.bysquareLoaded) {
                        console.log('Bysquare module loaded after delay, continuing...');

                        // Track delayed library load success
                        dataLayer.push({
                            'event': 'bysquare_library_load_success',
                            'load_type': 'delayed'
                        });

                        continueWithQRGeneration();
                    } else {
                        alert('Knižnica pre generovanie PayBySquare kódu sa nepodarilo načítať. Prosím, obnovte stránku a skúste znova.');

                        // Track library load error
                        dataLayer.push({
                            'event': 'bysquare_library_load_error'
                        });
                    }
                }, 1000);
                return;
            }

            // Track successful library detection
            dataLayer.push({
                'event': 'bysquare_library_load_success',
                'load_type': 'immediate'
            });

            continueWithQRGeneration();

            function continueWithQRGeneration() {
                // Start performance timing for QR generation
                const qrGenerationStartTime = performance.now();

                // Track amount input
                dataLayer.push({
                    'event': 'payment_amount_entered',
                    'amount': noAmount ? null : parseFloat(amount)
                });

                // Generate PayBySquare string
                const payBySquareString = generatePayBySquareString(
                    noAmount ? null : amount,
                    noVS ? '' : vs,
                    note,
                    settings.iban,
                    settings.swift,
                    settings.recipient
                );

                lastPayBySquareString = payBySquareString;

                console.log('PayBySquare string:', payBySquareString);

                // If PayBySquare string generation failed, stop here
                if (!payBySquareString) {
                    // Track QR generation error
                    dataLayer.push({
                        'event': 'qr_generation_error',
                        'error_type': 'bysquare_generation_failed'
                    });
                    return;
                }

                // Track variable symbol generation
                dataLayer.push({
                    'event': 'vs_auto_generated',
                    'vs': vs
                });

                // Track note field usage
                if (note && note.trim() !== '') {
                    dataLayer.push({
                        'event': 'note_field_used'
                    });
                }

                // Get QR container
                const qrContainer = document.getElementById('qr-code');

                /* DISABLED: Amount range categorization as requested
                // Categorize payment amount for analytics
                const paymentAmount = parseFloat(amount);
                let amountCategory;
                
                if (paymentAmount <= 10) amountCategory = '0-10';
                else if (paymentAmount <= 50) amountCategory = '10-50';
                else amountCategory = '50+';
                
                // Track amount category
                dataLayer.push({
                    'event': 'qr_generation_amount_range',
                    'amount_category': amountCategory
                });
                */

                try {
                    // Najprv vyčistíme kontajner
                    qrContainer.innerHTML = '';

                    // Použijeme qrcode-generator knižnicu
                    // Pre väčšie dáta potrebujeme vyššie typeNumber a lepšiu korekciu chýb
                    const typeNumber = 10; // Vyššie číslo pre väčšie množstvo dát
                    const errorCorrectionLevel = 'L'; // 'L', 'M', 'Q', 'H'

                    const qr = qrcode(typeNumber, errorCorrectionLevel);
                    qr.addData(payBySquareString);
                    qr.make();

                    // Vytvoríme obrázok QR kódu s onclick udalosťou pre návrat späť
                    const qrImg = qr.createImgTag(5); // cellSize=5 pixels
                    qrContainer.innerHTML = qrImg;

                    // Pridanie klikateľnosti na QR kód
                    const imgElement = qrContainer.querySelector('img');
                    if (imgElement) {
                        imgElement.style.cursor = 'pointer';
                        imgElement.title = 'Kliknite pre návrat do platby';
                        imgElement.onclick = backToPaymentForm;
                    }

                    console.log('QR kód úspešne vygenerovaný pomocou qrcode-generator');

                    // Zobrazíme QR kód a informácie
                    document.getElementById('qr-placeholder').classList.add('hidden');
                    document.getElementById('qr-code').classList.remove('hidden');
                    document.getElementById('qr-actions').classList.remove('hidden');
                    document.getElementById('qr-info').classList.remove('hidden');

                    // Zobraziť platebné informácie
                    document.getElementById('qr-amount').textContent = noAmount ? 'Bez sumy' : `${parseFloat(amount).toFixed(2)} €`;
                    document.getElementById('qr-vs').textContent = noVS ? 'Bez VS' : vs;
                    document.getElementById('qr-note').textContent = note || 'Bez poznámky';
                    document.getElementById('qr-iban').textContent = formatIBAN(settings.iban);

                    // Calculate QR generation time
                    const qrGenerationTime = performance.now() - qrGenerationStartTime;

                    // Track successful QR generation
                    dataLayer.push({
                        'event': 'qr_code_generated',
                        'generation_time_ms': Math.round(qrGenerationTime),
                        'qr_method': 'qrcode-generator',
                        'payment_amount': noAmount ? null : parseFloat(amount),
                        'has_note': note.trim() !== ''
                    });

                    if (!noVS) {
                        commitVS();
                    }

                    // Aktualizujeme zobrazenie VS pre ďalšie použitie
                    updateVSDisplay();

                    // Skryjeme okno 1 a zobrazíme okno 2
                    document.getElementById('payment-panel').classList.add('hidden');
                    document.getElementById('qr-panel').classList.remove('hidden');
                } catch (e) {
                    console.error('Chyba pri generovaní QR kódu:', e);
                    showErrorModal('Chyba QR', 'Nepodarilo sa vygenerovať QR kód. Skúste obnoviť stránku.');

                    dataLayer.push({
                        'event': 'qr_generation_error',
                        'error_type': 'qrcode_generator_failed',
                        'error_details': e.toString()
                    });
                }
            }
        }

        // Update VS display when page loads and after each generation
        setInterval(updateVSDisplay, 60000); // Update every minute for date changes

        // Funkcie pre validáciu numerického vstupu
        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            const inputValue = evt.target.value;

            // Povoliť iba číslice (0-9)
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                // Povoliť desatinnú bodku, ale iba ak ešte nie je v hodnote
                if (charCode === 46 && inputValue.indexOf('.') === -1) {
                    return true;
                }
                // Povoliť desatinnú čiarku a transformovať ju na bodku
                if (charCode === 44 && inputValue.indexOf('.') === -1) {
                    evt.target.value = evt.target.value + '.';
                    return false;
                }
                return false;
            }

            // Skontrolovať počet desatinných miest
            if (inputValue.includes('.')) {
                const parts = inputValue.split('.');
                if (parts[1] && parts[1].length >= 2 && !(evt.target.selectionStart > inputValue.indexOf('.') && evt.target.selectionEnd > evt.target.selectionStart)) {
                    return false;
                }
            }

            return true;
        }

        function validatePaste(evt) {
            // Získať vkladaný text
            const clipboardData = evt.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('Text');

            // Skontrolovať, či vkladaný text obsahuje iba číslice a maximálne jeden desatinný oddeľovač
            const regex = /^[0-9]+(\.[0-9]{0,2})?$/;
            if (!regex.test(pastedData.replace(',', '.'))) {
                return false;
            }

            // Ak sa používa čiarka, transformovať ju na bodku
            if (pastedData.includes(',')) {
                setTimeout(() => {
                    evt.target.value = evt.target.value.replace(',', '.');
                }, 0);
            }

            return true;
        }

        // Kód pre detekciu aktualizácií aplikácie
        const APP_VERSION = '1.1.4';

        let latestAvailableVersion = null;

        async function requestUpdateNow() {
            try {
                console.log('[SW] requestUpdateNow clicked', { latestAvailableVersion });
                if (latestAvailableVersion) {
                    sessionStorage.setItem('sw_updating_to', latestAvailableVersion);
                }

                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    console.warn('[SW] requestUpdateNow: no registration found, doing cache-busting reload');
                    reloadWithCacheBusting();
                    return;
                }

                console.log('[SW] requestUpdateNow: registration state', {
                    active: !!registration.active,
                    installing: !!registration.installing,
                    waiting: !!registration.waiting
                });

                const target = registration.waiting || registration.installing;
                if (target) {
                    console.log('[SW] requestUpdateNow: sending SKIP_WAITING to', registration.waiting ? 'waiting' : 'installing');
                    target.postMessage({ type: 'SKIP_WAITING' });
                    return;
                }

                console.log('[SW] requestUpdateNow: no waiting/installing SW, calling registration.update()');
                await registration.update();
                if (registration.waiting) {
                    console.log('[SW] requestUpdateNow: after update(), sending SKIP_WAITING to waiting');
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    return;
                }

                console.warn('[SW] requestUpdateNow: still no waiting SW after update(), reloading');
                reloadWithCacheBusting();
            } catch (e) {
                console.error('SW update request failed:', e);
                reloadWithCacheBusting();
            }
        }

        // Zobrazenie verzie v hlavičke
        document.addEventListener('DOMContentLoaded', function () {
            const versionDisplay = document.getElementById('app-version-display');
            if (versionDisplay) {
                versionDisplay.textContent = `v${APP_VERSION}`;
            }
        });

        // Cache-busting reload function
        function reloadWithCacheBusting() {
            let url = window.location.origin + window.location.pathname;
            // Zachová hash, ak je prítomný
            const hash = window.location.hash;
            // Pridaj alebo aktualizuj parameter v
            url += '?v=' + Date.now();
            if (hash) url += hash;
            window.location.replace(url);
        }

        // Čakanie na správy od service workera
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', function (event) {
                if (event.data && event.data.type === 'APP_VERSION') {
                    console.log('App version from service worker:', event.data.version);
                }

                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                    console.log('[SW] UPDATE_AVAILABLE received (ui handler):', event.data);
                    // Zobraziť užívateľovi notifikáciu o dostupnej aktualizácii
                    const notification = document.getElementById('update-notification');
                    if (notification) {
                        latestAvailableVersion = event.data.newVersion;
                        notification.textContent = '';
                        const txt = document.createTextNode('Je dostupná nová verzia (' + event.data.newVersion + ')! ');
                        const btn = document.createElement('button');
                        btn.className = 'bg-white text-secondary-700 px-2 py-1 rounded ml-3 font-medium';
                        btn.textContent = 'Aktualizovať teraz';
                        btn.addEventListener('click', requestUpdateNow);
                        notification.appendChild(txt);
                        notification.appendChild(btn);
                        notification.classList.remove('hidden');

                        // Sledovať notifikáciu v GTM
                        dataLayer.push({
                            'event': 'update_available',
                            'current_version': event.data.currentVersion,
                            'new_version': event.data.newVersion
                        });
                    }
                }
            });

            // Kontrola aktualizácií po načítaní stránky a každých 30 minút
            window.addEventListener('load', function () {
                setTimeout(() => {
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'CHECK_UPDATES'
                        });
                    }
                }, 3000);

                setInterval(() => {
                    if (navigator.onLine && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'CHECK_UPDATES'
                        });
                    }
                }, 1800000); // 30 minút
            });
        }
    </script>
</body>

</html>




