<!DOCTYPE html>
<html lang="sk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Primary Meta Tags -->
    <title>Platba OverQR – Rýchle a jednoduché platby QR kódom</title>
    <meta name="title" content="Platba OverQR – Rýchle a jednoduché platby QR kódom">
    <meta name="description"
        content="Vytvárajte QR kódy pre platby jednoducho, bez inštalácie. Moderná PWA pre platby vo formáte PayBySquare.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://platba.leqr.sk/">
    <meta property="og:title" content="Platba OverQR – Rýchle platby cez QR kód">
    <meta property="og:description"
        content="Zadajte sumu, poznámku a získajte QR kód pre rýchlu platbu. Bez registrácie, bez stresu.">
    <meta property="og:image" content="https://platba.leqr.sk/images/og-image.png">
    <meta property="fb:app_id" content="3201019116712940" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://platba.leqr.sk/">
    <meta name="twitter:title" content="Platba OverQR – Rýchle platby cez QR kód">
    <meta name="twitter:description"
        content="Vytvorte si bankový QR kód okamžite – pohodlne a bezpečne. Funguje aj offline.">
    <meta name="twitter:image" content="https://platba.leqr.sk/images/og-image.png">

    <!-- PWA and mobile -->
    <meta name="theme-color" content="#4c00c2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Platba OverQR">

    <!-- PWA podpora -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- QR Code Generator knižnica -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <!-- Import bysquare as ES Module -->
    <script type="module">
        // Import bysquare knižnice
        import { encode, decode, PaymentOptions, CurrencyCode } from "https://esm.sh/bysquare@latest";

        // Sprístupníme knižnicu globálne, aby ju mohli ostatné skripty používať
        window.bysquareModule = {
            encode,
            decode,
            PaymentOptions,
            CurrencyCode
        };

        // Signalizácia, že modul je načítaný
        window.bysquareLoaded = true;

        // Log pre overenie načítania
        console.log('Bysquare module loaded successfully');
    </script>
    <!-- Tailwind CSS -->
    <script src="tailwindcss.3.4.16.js"></script>
    <!-- FontAwesome Icons pre lepšiu používateľskú skúsenosť -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Registrácia Service Worker-a pre offline funkcionalitu -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('sw.js').then(function (registration) {
                    // Registrácia bola úspešná
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    // Sledovanie úspešnej registrácie service workera
                    dataLayer.push({
                        'event': 'service_worker_registered',
                        'sw_scope': registration.scope
                    });
                }, function (err) {
                    // registrácia zlyhala :(
                    console.log('ServiceWorker registration failed: ', err);
                    // Sledovanie neúspešnej registrácie service workera
                    dataLayer.push({
                        'event': 'service_worker_registration_failed',
                        'error': err.toString()
                    });
                });

                // Track app open event
                const isReturningUser = localStorage.getItem('paybySquareSettings') !== null;
                dataLayer.push({
                    'event': 'app_opened',
                    'user_type': isReturningUser ? 'returning' : 'new'
                });

                // Track if app is in offline mode
                if (!navigator.onLine) {
                    dataLayer.push({
                        'event': 'offline_mode_entered'
                    });
                }

                // Listen for online/offline events
                window.addEventListener('online', function() {
                    dataLayer.push({
                        'event': 'app_online'
                    });
                });
                
                window.addEventListener('offline', function() {
                    dataLayer.push({
                        'event': 'offline_mode_entered'
                    });
                });

                // Track if app was launched from installed PWA
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    dataLayer.push({
                        'event': 'app_installed'
                    });
                }

                // Track app load time
                const loadTime = performance.now();
                dataLayer.push({
                    'event': 'app_load_time',
                    'load_time_ms': Math.round(loadTime)
                });
            });
        }
    </script>

    <script>
        // Tailwind konfigurácia pre konzistentné farby a mobile-first prístup
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f7ff',
                            100: '#e0eeff',
                            200: '#c7dfff',
                            300: '#a0c7fe',
                            400: '#72a9fc',
                            500: '#4f83f7',
                            600: '#3a63ee',
                            700: '#2e4fda',
                            800: '#2941b0',
                            900: '#263c8b',
                        },
                        secondary: {
                            50: '#f9f5ff',
                            100: '#f0e9ff',
                            200: '#e4d4ff',
                            300: '#cfb1fe',
                            400: '#b882fb',
                            500: '#a55af5',
                            600: '#933aea',
                            700: '#7e2ed1',
                            800: '#6827aa',
                            900: '#5b2589',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        glass: '0 8px 32px 0 rgba(31, 38, 135, 0.1)',
                        'glass-hover': '0 8px 32px 0 rgba(31, 38, 135, 0.2)',
                    }
                }
            }
        };
    </script>
    <script>
        // Zabezpečenie, že qrcode bude dostupný ako globálna funkcia
        window.addEventListener('load', function () {
            // Kontrola dostupnosti funkcie qrcode (s malým q) z knižnice qrcode-generator
            if (typeof qrcode === 'undefined' || typeof qrcode !== 'function') {
                console.error('qrcode-generator knižnica nebola načítaná správne. Generovanie QR kódu nemusí fungovať.');
            } else {
                console.log('qrcode-generator knižnica je dostupná:', typeof qrcode);
                try {
                    // Skúsme vytvoriť jednoduchý QR kód pre kontrolu funkčnosti
                    const testQr = qrcode(4, 'L');
                    console.log('qrcode-generator knižnica funguje správne');
                } catch (e) {
                    console.error('qrcode-generator knižnica je dostupná, ale nefunguje správne:', e);
                }
            }
        });
    </script>
    <style>
        /* Custom štýly, ktoré nie je možné dosiahnuť pomocou Tailwind */
        .animated-gradient {
            background: linear-gradient(-45deg, #4f83f7, #2e4fda, #a55af5, #7e2ed1);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-56CKR4RC');</script>
    <!-- End Google Tag Manager -->
</head>

<body class="min-h-screen animated-gradient text-gray-800 p-4 antialiased">
    <!-- Notifikácia o aktualizácii -->
    <div id="update-notification" class="hidden fixed top-0 left-0 right-0 bg-secondary-600 text-white text-center p-2 z-50"></div>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-56CKR4RC" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="max-w-6xl mx-auto">
        <!-- Hlavička -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-2 drop-shadow-lg">
                <i class="fas fa-qrcode mr-2"></i> Platba OverQR
            </h1>
            <p class="text-white text-opacity-90 text-lg md:text-xl">Mobilné platby jednoducho</p>
        </header>

        <!-- Hlavný obsah - okno 1 a okno 2, vždy len jedno viditeľné -->
        <div class="max-w-xl mx-auto">
            <!-- Okno 1: Panel s formulárom -->
            <div id="payment-panel"
                class="glassmorphism rounded-2xl shadow-glass hover:shadow-glass-hover transition duration-300">
                <!-- Záložky -->
                <div class="flex rounded-t-2xl overflow-hidden">
                    <button id="payment-tab" onclick="switchTab('payment')"
                        class="flex-1 py-3 px-4 font-medium transition duration-300 bg-white text-primary-600">
                        <i class="fas fa-credit-card mr-2"></i> Platba
                    </button>
                    <button id="settings-tab" onclick="switchTab('settings')"
                        class="flex-1 py-3 px-4 font-medium transition duration-300 bg-gray-100 bg-opacity-50 text-gray-600">
                        <i class="fas fa-cog mr-2"></i> Nastavenia
                    </button>
                </div>

                <!-- Formulár platby -->
                <div id="payment-form" class="p-5">
                    <h2 class="text-xl font-bold text-primary-700 mb-4 pb-2 border-b border-gray-200">Vytvorenie platby
                    </h2>

                    <!-- Suma -->
                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Suma (€)</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-euro-sign text-gray-400"></i>
                            </div>
                            <input type="text" inputmode="decimal" pattern="[0-9]+(\.[0-9]{0,2})?" id="amount"
                                min="0.01" placeholder="5.00"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200"
                                onkeypress="return isNumberKey(event)" onpaste="return validatePaste(event)">
                        </div>
                        <div id="amount-error" class="mt-1 text-sm text-red-600"></div>
                    </div>

                    <!-- Poznámka -->
                    <div class="mb-4">
                        <label for="note" class="block text-sm font-medium text-gray-700 mb-2">Poznámka k platbe</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-comment-alt text-gray-400"></i>
                            </div>
                            <input type="text" id="note" maxlength="35" placeholder="Popis platby (max 35 znakov)"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                    </div>

                    <!-- Variabilný symbol -->
                    <div class="mb-6">
                        <label for="vs-display" class="block text-sm font-medium text-gray-700 mb-2">Variabilný
                            symbol</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-hashtag text-gray-400"></i>
                            </div>
                            <input type="text" id="vs-display" readonly placeholder="Automaticky generovaný"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 bg-gray-50 rounded-lg cursor-not-allowed transition duration-200">
                        </div>
                    </div>

                    <!-- Tlačidlo generovať QR -->
                    <button onclick="generateQR()"
                        class="w-full py-3 bg-gradient-to-r from-primary-600 to-secondary-600 hover:from-primary-700 hover:to-secondary-700 rounded-lg text-white font-medium flex items-center justify-center transform transition duration-300 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-qrcode mr-2"></i> Generovať QR kód
                    </button>
                </div>

                <!-- Formulár nastavení -->
                <div id="settings-form" class="p-5 hidden">
                    <h2 class="text-xl font-bold text-primary-700 mb-4 pb-2 border-b border-gray-200">Bankové údaje</h2>

                    <!-- IBAN -->
                    <div class="mb-4">
                        <label for="iban" class="block text-sm font-medium text-gray-700 mb-2">IBAN účtu</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-university text-gray-400"></i>
                            </div>
                            <input type="text" id="iban" placeholder="SK7700000000000000000000" maxlength="34"
                                class="uppercase block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                        <div id="iban-error" class="mt-1 text-sm text-red-600"></div>
                    </div>

                    <!-- SWIFT/BIC -->
                    <div class="mb-4">
                        <label for="swift" class="block text-sm font-medium text-gray-700 mb-2">SWIFT/BIC kód</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-globe text-gray-400"></i>
                            </div>
                            <input type="text" id="swift" placeholder="CEKOSKBX" maxlength="11"
                                class="uppercase block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                    </div>

                    <!-- Názov obchodníka -->
                    <div class="mb-6">
                        <label for="recipient" class="block text-sm font-medium text-gray-700 mb-2">Názov
                            obchodníka</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-building text-gray-400"></i>
                            </div>
                            <input type="text" id="recipient" placeholder="Váš obchodný názov"
                                class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition duration-200">
                        </div>
                    </div>

                    <!-- Tlačidlo uložiť -->
                    <button onclick="saveSettings()"
                        class="w-full py-3 bg-gradient-to-r from-primary-600 to-secondary-600 hover:from-primary-700 hover:to-secondary-700 rounded-lg text-white font-medium flex items-center justify-center transform transition duration-300 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-save mr-2"></i> Uložiť nastavenia
                    </button>

                    <!-- Potvrdenie uloženia -->
                    <div id="settings-success"
                        class="mt-4 py-2 px-3 bg-green-100 border border-green-300 text-green-700 text-center rounded-md hidden transition duration-300">
                        <i class="fas fa-check-circle mr-1"></i> Nastavenia boli úspešne uložené
                    </div>
                </div>
            </div>

            <!-- Okno 2: Panel s QR kódom (skryté na začiatku) -->
            <div id="qr-panel"
                        </div>
                        <div id="qr-code" class="bg-white p-5 rounded-xl shadow-md my-4 hidden"></div>
                        <div id="qr-info"
                            class="w-full bg-gray-50 p-4 rounded-lg border-l-4 border-primary-500 text-sm hidden">
                            <div class="grid grid-cols-1 gap-2">
                                <p><strong>Suma:</strong> <span id="qr-amount"></span></p>
                                <p><strong>IBAN:</strong> <span id="qr-iban"></span></p>
                                <p><strong>VS:</strong> <span id="qr-vs"></span></p>
                                <p><strong>Poznámka:</strong> <span id="qr-note"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Úložisko v pamäti (v reálnej implementácii nahradené lokálnym úložiskom)
        let settings = {
            iban: '',
            swift: '',
            recipient: ''
        };

        let dailyCounters = {};

        // Load settings on page load
        window.onload = function () {
            loadSettings();
            updateVSDisplay();
        };

        function switchTab(tab) {
            // Skryjeme všetky formuláre
            document.getElementById('payment-form').classList.add('hidden');
            document.getElementById('settings-form').classList.add('hidden');

            // Zobrazíme len vybraný formulár
            document.getElementById(tab + '-form').classList.remove('hidden');

            // Aktualizujeme štýly tlačidiel záložiek
            if (tab === 'payment') {
                document.getElementById('payment-tab').classList.remove('bg-gray-100', 'bg-opacity-50', 'text-gray-600');
                document.getElementById('payment-tab').classList.add('bg-white', 'text-primary-600');

                document.getElementById('settings-tab').classList.remove('bg-white', 'text-primary-600');
                document.getElementById('settings-tab').classList.add('bg-gray-100', 'bg-opacity-50', 'text-gray-600');

                // Track payment tab opened
                dataLayer.push({
                    'event': 'payment_form_opened'
                });
            } else {
                document.getElementById('settings-tab').classList.remove('bg-gray-100', 'bg-opacity-50', 'text-gray-600');
                document.getElementById('settings-tab').classList.add('bg-white', 'text-primary-600');

                document.getElementById('payment-tab').classList.remove('bg-white', 'text-primary-600');
                document.getElementById('payment-tab').classList.add('bg-gray-100', 'bg-opacity-50', 'text-gray-600');
                
                // Track settings tab opened
                dataLayer.push({
                    'event': 'settings_opened'
                });
            }
        }

        // Load settings from localStorage on page load
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('paybySquareSettings');
                const savedCounters = localStorage.getItem('paybySquareDailyCounters');

                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                    console.log('Nastavenia načítané z localStorage:', settings);

                    // Vyplníme formulár načítanými hodnotami
                    if (settings.iban) document.getElementById('iban').value = settings.iban;
                    if (settings.swift) document.getElementById('swift').value = settings.swift;
                    if (settings.recipient) document.getElementById('recipient').value = settings.recipient;
                }

                if (savedCounters) {
                    dailyCounters = JSON.parse(savedCounters);
                    console.log('Počítadlá načítané z localStorage:', dailyCounters);
                }

                updateVSDisplay();
            } catch (error) {
                console.error('Chyba pri načítavaní dát z localStorage:', error);
            }
        }

        // Načítame nastavenia pri štarte stránky
        window.addEventListener('DOMContentLoaded', loadSettings);

        function saveSettings() {
            const inputIban = document.getElementById('iban').value.trim();
            const swift = document.getElementById('swift').value.trim();
            const recipient = document.getElementById('recipient').value.trim();

            // Track form interaction
            dataLayer.push({
                'event': 'settings_form_submitted',
                'has_swift': swift.trim() !== '',
                'has_recipient': recipient.trim() !== ''
            });

            // Validate IBAN and get the cleaned version (without spaces)
            const validatedIban = validateIBAN(inputIban);
            if (!validatedIban) {
                document.getElementById('iban-error').textContent = 'Zadajte platný IBAN';
                
                // Track IBAN validation error
                dataLayer.push({
                    'event': 'iban_validation_error',
                    'input_length': inputIban.length
                });
                return;
            }

            document.getElementById('iban-error').textContent = '';

            settings = { iban: validatedIban, swift, recipient };

            // Uložíme nastavenia do localStorage
            try {
                localStorage.setItem('paybySquareSettings', JSON.stringify(settings));
                console.log('Nastavenia uložené do localStorage:', settings);
                
                // Track successful settings save
                dataLayer.push({
                    'event': 'settings_saved',
                    'country_code': validatedIban.slice(0, 2),
                    'has_swift': swift.trim() !== '',
                    'has_recipient': recipient.trim() !== ''
                });
            } catch (error) {
                console.error('Chyba pri ukladaní nastavení do localStorage:', error);
                
                // Track localStorage error
                dataLayer.push({
                    'event': 'settings_save_error',
                    'error_type': 'localStorage_error'
                });
            }

            document.getElementById('settings-success').textContent = 'Nastavenia uložené!';
            setTimeout(() => {
                document.getElementById('settings-success').textContent = '';
            }, 2000);

            // Uložíme a prejdeme na záložku platby
            setTimeout(() => {
                switchTab('payment');
                document.getElementById('settings-success').classList.add('hidden');
                document.getElementById('settings-success').textContent = '';
            }, 1000);
        }

        function validateIBAN(iban) {
            console.log('Validating IBAN:', iban);

            // Remove spaces from the IBAN
            const cleanIban = iban.replace(/\s/g, '').toUpperCase();
            console.log('Cleaned IBAN:', cleanIban);

            // IBAN country code length map
            const countryLengths = {
                AL: 28, AD: 24, AT: 20, AZ: 28, BH: 22, BY: 28, BE: 16, BA: 20, BR: 29,
                BG: 22, CR: 22, HR: 21, CY: 28, CZ: 24, DK: 18, DO: 28, EG: 29, SV: 28,
                EE: 20, FO: 18, FI: 18, FR: 27, GE: 22, DE: 22, GI: 23, GR: 27, GL: 18,
                GT: 28, VA: 22, HU: 28, IS: 26, IQ: 23, IE: 22, IL: 23, IT: 27, JO: 30,
                KZ: 20, XK: 20, KW: 30, LV: 21, LB: 28, LI: 21, LT: 20, LU: 20, MK: 19,
                MT: 31, MR: 27, MU: 30, MD: 24, MC: 27, ME: 22, NL: 18, NO: 15, PK: 24,
                PS: 29, PL: 28, PT: 25, QA: 29, RO: 24, LC: 32, SM: 27, ST: 25, SA: 24,
                RS: 22, SC: 31, SK: 24, SI: 19, ES: 24, SE: 24, CH: 21, TL: 23, TN: 24,
                TR: 26, UA: 29, AE: 23, GB: 22, VG: 24
            };

            // Check if it's a string with minimum IBAN length
            if (typeof cleanIban !== 'string') {
                console.error('IBAN validation failed: Not a string');
                return false;
            }

            if (cleanIban.length < 15) {
                console.error('IBAN validation failed: Length too short (minimum 15 characters)', cleanIban.length);
                return false;
            }

            // Extract country code
            const countryCode = cleanIban.slice(0, 2);
            console.log('Country code:', countryCode);

            // Verify country code is supported
            if (!Object.keys(countryLengths).includes(countryCode)) {
                console.error('IBAN validation failed: Unsupported country code', countryCode);
                return false;
            }

            // Verify length for country
            const expectedLength = countryLengths[countryCode];
            if (expectedLength !== cleanIban.length) {
                console.error('IBAN validation failed: Invalid length for country', {
                    country: countryCode,
                    expected: expectedLength,
                    actual: cleanIban.length
                });
                return false;
            }

            // Move first 4 characters to the end
            const reformattedIban = cleanIban.slice(4) + cleanIban.slice(0, 4);
            console.log('Reformatted IBAN:', reformattedIban);

            // Replace letters with corresponding numbers (A=10, B=11, etc.)
            const onlyDigits = reformattedIban.replace(/[A-Z]/g, letter =>
                (letter.charCodeAt(0) - 55).toString()
            );
            console.log('Digits only:', onlyDigits);

            // Perform the mod-97 operation
            function mod97(numStr) {
                let checksum = numStr.slice(0, 2);
                let fragment;

                for (let offset = 2; offset < numStr.length; offset += 7) {
                    fragment = checksum + numStr.substring(offset, offset + 7);
                    checksum = parseInt(fragment, 10) % 97;
                }

                return checksum;
            }

            // IBAN is valid if the remainder is 1
            const remainder = mod97(onlyDigits);
            const isValid = remainder === 1;

            if (!isValid) {
                console.error('IBAN validation failed: Invalid checksum', {
                    remainder: remainder,
                    expected: 1
                });
            } else {
                console.log('IBAN validation successful!');
            }

            // Return both validation result and cleaned IBAN
            return isValid ? cleanIban : false;
        }

        function generateVS() {
            const today = new Date();
            const dateKey = today.toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD

            if (!dailyCounters[dateKey]) {
                dailyCounters[dateKey] = 0;
            }

            dailyCounters[dateKey]++;

            // Uložíme počítadlá do localStorage
            try {
                localStorage.setItem('paybySquareDailyCounters', JSON.stringify(dailyCounters));
                console.log('Počítadlá uložené do localStorage:', dailyCounters);
            } catch (error) {
                console.error('Chyba pri ukladaní počítadiel do localStorage:', error);
            }

            return dateKey + String(dailyCounters[dateKey]).padStart(6, '0');
        }

        function updateVSDisplay() {
            const today = new Date();
            const dateKey = today.toISOString().slice(2, 10).replace(/-/g, '');
            const nextCounter = (dailyCounters[dateKey] || 0) + 1;
            const nextVS = dateKey + String(nextCounter).padStart(6, '0');

            document.getElementById('vs-display').value = nextVS;
        }

        // Funkcia na formátovanie IBAN pre lepšiu čitateľnosť
        function formatIBAN(iban) {
            // Vkladá medzery po každých 4 znakoch
            if (!iban) return '';
            return iban.replace(/(.{4})/g, '$1 ').trim();
        }

        function generatePayBySquareString(amount, vs, note, iban, swift, recipient) {
            try {
                // Počkáme, či je bysquare knižnica načítaná
                if (!window.bysquareLoaded || !window.bysquareModule) {
                    throw new Error('Knižnica bysquare nie je načítaná. Prosím, obnovte stránku.');
                }

                // Používame globálne dostupnú bysquare knižnicu
                const { encode, PaymentOptions, CurrencyCode } = window.bysquareModule;

                // Príprava platobných údajov podľa dokumentácie bysquare
                const paymentData = {
                    payments: [
                        {
                            type: PaymentOptions.PaymentOrder, // PaymentOrder = 1
                            amount: parseFloat(amount),
                            currencyCode: CurrencyCode.EUR,
                            // Pridáme variabilný symbol, ak je zadaný
                            ...(vs && vs.trim() !== '' && { variableSymbol: vs.toString() }),
                            // Pridáme poznámku, ak je zadaná
                            ...(note && note.trim() !== '' && { paymentNote: note }),
                            // Pridáme bankové účty
                            bankAccounts: [
                                {
                                    iban: iban,
                                    // Pridáme SWIFT/BIC kód, ak je zadaný
                                    ...(swift && swift.trim() !== '' && { bic: swift })
                                }
                            ],
                            // Pridáme meno príjemcu, ak je zadané
                            ...(recipient && recipient.trim() !== '' && { beneficiaryName: recipient })
                        }
                    ]
                };

                // Vygenerovanie kódu PayBySquare
                console.log('Generujem PayBySquare kód s údajmi:', paymentData);
                const payBySquareString = encode(paymentData);
                console.log('PayBySquare kód vygenerovaný:', payBySquareString);
                return payBySquareString;
            } catch (error) {
                console.error('Chyba pri generovaní PayBySquare kódu:', error);
                alert('Nepodarilo sa vygenerovať PayBySquare kód: ' + error.message);
                return null;
            }
        }

        // Funkcia pre prepnutie späť do okna platby
        function backToPaymentForm() {
            // Skryjeme QR panel
            document.getElementById('qr-panel').classList.add('hidden');

            // Zobrazíme platbný panel
            document.getElementById('payment-panel').classList.remove('hidden');

            // Track return to payment form
            dataLayer.push({
                'event': 'return_to_payment_form'
            });

            // Vymažeme hodnoty vo formulári
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';

            // Focus na pole sumy pre rýchle vyplnenie
            document.getElementById('amount').focus();
        }

        function generateQR() {
            // Get form values
            const amount = document.getElementById('amount').value;
            const vs = generateVS();
            const note = document.getElementById('note').value;
            
            // Track payment form interaction
            dataLayer.push({
                'event': 'payment_form_started',
                'has_note': note.trim() !== ''
            });

            // Check if settings are available
            if (!settings.iban) {
                alert('Prosím, nastavte IBAN v nastaveniach.');
                
                // Track missing settings error
                dataLayer.push({
                    'event': 'qr_generation_error',
                    'error_type': 'missing_iban'
                });
                return;
            }

            // Check if bysquare module is loaded
            if (!window.bysquareLoaded) {
                console.log('Bysquare module not yet loaded, waiting...');
                
                // Track library loading wait
                dataLayer.push({
                    'event': 'bysquare_library_loading',
                    'action': 'waiting'
                });
                
                // Wait a moment for the module to load
                setTimeout(() => {
                    if (window.bysquareLoaded) {
                        console.log('Bysquare module loaded after delay, continuing...');
                        
                        // Track delayed library load success
                        dataLayer.push({
                            'event': 'bysquare_library_load_success',
                            'load_type': 'delayed'
                        });
                        
                        continueWithQRGeneration();
                    } else {
                        alert('Knižnica pre generovanie PayBySquare kódu sa nepodarilo načítať. Prosím, obnovte stránku a skúste znova.');
                        
                        // Track library load error
                        dataLayer.push({
                            'event': 'bysquare_library_load_error'
                        });
                    }
                }, 1000);
                return;
            }
            
            // Track successful library detection
            dataLayer.push({
                'event': 'bysquare_library_load_success',
                'load_type': 'immediate'
            });

            continueWithQRGeneration();

            function continueWithQRGeneration() {
                // Start performance timing for QR generation
                const qrGenerationStartTime = performance.now();
                
                // Track amount input
                dataLayer.push({
                    'event': 'payment_amount_entered',
                    'amount': parseFloat(amount)
                });
                
                // Generate PayBySquare string
                const payBySquareString = generatePayBySquareString(
                    amount,
                    vs,
                    note,
                    settings.iban,
                    settings.swift,
                    settings.recipient
                );

                console.log('PayBySquare string:', payBySquareString);

                // If PayBySquare string generation failed, stop here
                if (!payBySquareString) {
                    // Track QR generation error
                    dataLayer.push({
                        'event': 'qr_generation_error',
                        'error_type': 'bysquare_generation_failed'
                    });
                    return;
                }
                
                // Track variable symbol generation
                dataLayer.push({
                    'event': 'vs_auto_generated',
                    'vs': vs
                });
                
                // Track note field usage
                if (note && note.trim() !== '') {
                    dataLayer.push({
                        'event': 'note_field_used'
                    });
                }

                // Get QR container
                const qrContainer = document.getElementById('qr-code');
                
                /* DISABLED: Amount range categorization as requested
                // Categorize payment amount for analytics
                const paymentAmount = parseFloat(amount);
                let amountCategory;
                
                if (paymentAmount <= 10) amountCategory = '0-10';
                else if (paymentAmount <= 50) amountCategory = '10-50';
                else amountCategory = '50+';
                
                // Track amount category
                dataLayer.push({
                    'event': 'qr_generation_amount_range',
                    'amount_category': amountCategory
                });
                */

                try {
                    // Najprv vyčistíme kontajner
                    qrContainer.innerHTML = '';

                    // Použijeme qrcode-generator knižnicu
                    // Pre väčšie dáta potrebujeme vyššie typeNumber a lepšiu korekciu chýb
                    const typeNumber = 10; // Vyššie číslo pre väčšie množstvo dát
                    const errorCorrectionLevel = 'L'; // 'L', 'M', 'Q', 'H'

                    const qr = qrcode(typeNumber, errorCorrectionLevel);
                    qr.addData(payBySquareString);
                    qr.make();

                    // Vytvoríme obrázok QR kódu s onclick udalosťou pre návrat späť
                    const qrImg = qr.createImgTag(5); // cellSize=5 pixels
                    qrContainer.innerHTML = qrImg;

                    // Pridanie klikateľnosti na QR kód
                    const imgElement = qrContainer.querySelector('img');
                    if (imgElement) {
                        imgElement.style.cursor = 'pointer';
                        imgElement.title = 'Kliknite pre návrat do platby';
                        imgElement.onclick = backToPaymentForm;
                    }

                    console.log('QR kód úspešne vygenerovaný pomocou qrcode-generator');

                    // Zobrazíme QR kód a informácie
                    document.getElementById('qr-placeholder').classList.add('hidden');
                    document.getElementById('qr-code').classList.remove('hidden');
                    document.getElementById('qr-info').classList.remove('hidden');

                    // Zobraziť platebné informácie
                    document.getElementById('qr-amount').textContent = `${parseFloat(amount).toFixed(2)} €`;
                    document.getElementById('qr-vs').textContent = vs;
                    document.getElementById('qr-note').textContent = note || 'Bez poznámky';
                    document.getElementById('qr-iban').textContent = formatIBAN(settings.iban);
                    
                    // Calculate QR generation time
                    const qrGenerationTime = performance.now() - qrGenerationStartTime;
                    
                    // Track successful QR generation
                    dataLayer.push({
                        'event': 'qr_code_generated',
                        'generation_time_ms': Math.round(qrGenerationTime),
                        'qr_method': 'qrcode-generator',
                        'payment_amount': parseFloat(amount),
                        'has_note': note.trim() !== ''
                    });

                    // Aktualizujeme zobrazenie VS pre ďalšie použitie
                    updateVSDisplay();

                    // Skryjeme okno 1 a zobrazíme okno 2
                    document.getElementById('payment-panel').classList.add('hidden');
                    document.getElementById('qr-panel').classList.remove('hidden');
                } catch (e) {
                    console.error('Chyba pri generovaní QR kódu:', e);

                    // Alternatívny spôsob generovania QR kódu
                    try {
                        // Skúsime použiť jednoduchšie riešenie s createElement
                        const img = document.createElement('img');

                        // Vytvoríme jednoduchší QR kód pomocou API služby
                        // Používame Google Chart API pre QR kódy pre jednoduchší prístup
                        const encodedData = encodeURIComponent(payBySquareString);
                        img.src = `https://chart.googleapis.com/chart?cht=qr&chl=${encodedData}&chs=256x256&chld=L|1`;
                        img.width = 256;
                        img.height = 256;
                        img.alt = 'QR kód pre platbu';
                        img.style.cursor = 'pointer';
                        img.title = 'Kliknite pre návrat do platby';
                        img.onclick = backToPaymentForm;

                        qrContainer.appendChild(img);
                        
                        // Zobrazíme QR kód a informácie
                        document.getElementById('qr-placeholder').classList.add('hidden');
                        document.getElementById('qr-code').classList.remove('hidden');
                        document.getElementById('qr-info').classList.remove('hidden');
                        
                        // Zobraziť platebné informácie
                        document.getElementById('qr-amount').textContent = `${parseFloat(amount).toFixed(2)} €`;
                        document.getElementById('qr-vs').textContent = vs;
                        document.getElementById('qr-note').textContent = note || 'Bez poznámky';
                        document.getElementById('qr-iban').textContent = formatIBAN(settings.iban);
                        
                        // Calculate QR generation time
                        const qrGenerationTime = performance.now() - qrGenerationStartTime;
                        
                        // Track successful QR generation with fallback method
                        dataLayer.push({
                            'event': 'qr_code_generated',
                            'generation_time_ms': Math.round(qrGenerationTime),
                            'qr_method': 'google_chart_api',
                            'fallback_qr_method_used': true,
                            'payment_amount': parseFloat(amount),
                            'has_note': note.trim() !== ''
                        });
                        
                        // Aktualizujeme zobrazenie VS pre ďalšie použitie
                        updateVSDisplay();
                        
                        // Skryjeme okno 1 a zobrazíme okno 2
                        document.getElementById('payment-panel').classList.add('hidden');
                        document.getElementById('qr-panel').classList.remove('hidden');
                    } catch (backupError) {
                        console.error('Záložné riešenie QR kódu zlyhalo:', backupError);
                        alert('Nepodarilo sa vygenerovať QR kód. Skontrolujte konzolu pre viac informácií.');
                        
                        // Track fallback QR generation error
                        dataLayer.push({
                            'event': 'qr_generation_error',
                            'error_type': 'fallback_method_failed',
                            'error_details': backupError.toString()
                        });
                    }
                }
            }
        }

        // Update VS display when page loads and after each generation
        setInterval(updateVSDisplay, 60000); // Update every minute for date changes

        // Funkcie pre validáciu numerického vstupu
        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            const inputValue = evt.target.value;

            // Povoliť iba číslice (0-9)
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                // Povoliť desatinnú bodku, ale iba ak ešte nie je v hodnote
                if (charCode === 46 && inputValue.indexOf('.') === -1) {
                    return true;
                }
                // Povoliť desatinnú čiarku a transformovať ju na bodku
                if (charCode === 44 && inputValue.indexOf('.') === -1) {
                    evt.target.value = evt.target.value + '.';
                    return false;
                }
                return false;
            }

            // Skontrolovať počet desatinných miest
            if (inputValue.includes('.')) {
                const parts = inputValue.split('.');
                if (parts[1] && parts[1].length >= 2 && !(evt.target.selectionStart > inputValue.indexOf('.') && evt.target.selectionEnd > evt.target.selectionStart)) {
                    return false;
                }
            }

            return true;
        }

        function validatePaste(evt) {
            // Získať vkladaný text
            const clipboardData = evt.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('Text');

            // Skontrolovať, či vkladaný text obsahuje iba číslice a maximálne jeden desatinný oddeľovač
            const regex = /^[0-9]+(\.[0-9]{0,2})?$/;
            if (!regex.test(pastedData.replace(',', '.'))) {
                return false;
            }

            // Ak sa používa čiarka, transformovať ju na bodku
            if (pastedData.includes(',')) {
                setTimeout(() => {
                    evt.target.value = evt.target.value.replace(',', '.');
                }, 0);
            }

            return true;
        }

        // Kód pre detekciu aktualizácií aplikácie
        const APP_VERSION = '1.0.1';

        // Čakanie na správy od service workera
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'APP_VERSION') {
                    console.log('App version from service worker:', event.data.version);
                }
                
                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                    // Zobraziť užívateľovi notifikáciu o dostupnej aktualizácii
                    const notification = document.getElementById('update-notification');
                    if (notification) {
                        notification.innerHTML = `Je dostupná nová verzia (${event.data.newVersion})! <button class="bg-white text-secondary-700 px-2 py-1 rounded ml-3 font-medium" onclick="window.location.reload()">Aktualizovať teraz</button>`;
                        notification.classList.remove('hidden');
                        
                        // Sledovať notifikáciu v GTM
                        dataLayer.push({
                            'event': 'update_available',
                            'current_version': event.data.currentVersion,
                            'new_version': event.data.newVersion
                        });
                    }
                }
            });

            // Kontrola aktualizácií po načítaní stránky
            window.addEventListener('load', function() {
                setTimeout(() => {
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'CHECK_UPDATES'
                        });
                    }
                }, 3000); // Odložiť kontrolu o 3 sekundy

                // Nastaviť periodickú kontrolu (každú hodinu)
                setInterval(() => {
                    if (navigator.onLine && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'CHECK_UPDATES'
                        });
                    }
                }, 60 * 60 * 1000); // 1 hodina
            });
        }
    </script>
</body>

</html>